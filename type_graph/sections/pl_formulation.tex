Let $\mathcal{R}$ be a rewriting systems. Let $\Sigma$ be the finite set of arrow labels. We look for a type graph $T$ in the all $\Sigma$ labeled simple graph 
of size $n$. Let $\delta \mathop{\in} \mathbb{R}^+$

\subsection{Decision Variables}
We define decision variables
\begin{flalign*}
        x_a &\in \set{0,1}, \text{for all arrows $a \mathop{\in} E(T)$}\\
        y_a &\in \mathbb{R}^+, \text{for all arrows $a \mathop{\in} E(T)$}\\
        z_\rho & \mathop{\in} \set{0,1}, \text{for all rules $\rho \mathop{\in} \mathcal{R}$}
\end{flalign*} 
with constraints
\begin{flalign*}
        0 &\leq y_a < 1,\text{if $x_a \mathop{=} 1$ for all arrows $a \mathop{\in} E(T)$}\\
        y_a &= M,\text{if $x_a \mathop{=} 0$ for all arrows $a \mathop{\in} E(T)$} \\
        \sum_{\rho \mathop{\in} \mathcal{R}} z_\rho &\geq 1
\end{flalign*}

% \subsubsection{impl}
% Big-M Constraints to ensure $y=M$ when $x \mathop{=} 0$:
% \begin{itemize}
%     \item $y \leq M\mathop{+}M * x \mathop{=} M\mathop{+}0 \mathop{=} M$
%     \item $y \mathop{\geq} M - M * x \mathop{=} M - 0 \mathop{=} M$
% \end{itemize}
% when $x \mathop{=} 1$:
% \begin{itemize}
%     \item $y \leq M\mathop{+}M * x \mathop{=} M\mathop{+}M \mathop{=} 2*M$
%     \item $y \mathop{\geq} M - M * x \mathop{=} M - M \mathop{=} 0$
% \end{itemize}
% Big-M Constraints to ensure $0 \leq y \leq 1$ when $x \mathop{=} 1$:
% \begin{itemize}
%     \item $y < x\mathop{+}(1 - x) * M \mathop{=} 1\mathop{+}0 * M \mathop{=} 1$
% \end{itemize}

\subsection{Auxiliary Variables} 
For every rule $(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R) \mathop{\in} \mathcal{R}$, for every $h \mathop{\in} Hom(L, T) \mathop{\cup} Hom(R,T)$, we define 
        \begin{flalign*}
            H(h) &\in \set{0,1}\\
            H'(h) &\in \mathbb{R}^+\\
        \end{flalign*}
with onstraints
        \begin{flalign*}
            H(h) &= \operatorname{and}(\set{x_{h(a)} \mid~ a \mathop{\in} \operatorname{E}(\operatorname{dom}(h))})\\
            % H'(h) &= \operatorname{sum}(\set{y_{h(a)} \mid~ a \mathop{\in} \operatorname{E}(\operatorname{dom}(h))})\\
            H(h) &= 0 \mathop{\rightarrow} H'(h) \mathop{=} M \\
            H(h) &= 1 \mathop{\rightarrow} H'(h) \mathop{=} \sum_{b \mathop{\in} E(T)}\sum_{\substack{a \mathop{\in} \operatorname{E}(\operatorname{dom}(h))\\
            h(a) \mathop{=} b}} y_b
        \end{flalign*}

For every rule $\rho =(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R)\in \mathcal{R}$,
for every $t_K \mathop{\in} Hom(K,T)$,  
for every $f \mathop{\in} \set{l,r}$, 
% we define $K(\rho,t_K,f)$ be a binary auxiliary variable and $K'(\rho,t_K,f)$, $\delta'(\rho,t_K)$ be continuous auxiliary variables such that 
we define variables 
\begin{flalign*}
    \delta'(\rho,t_K) &\in \mathbb{R}^+\\
    K(t_K,f) &\in \set{0,1}\\
    K'(t_K,f) &\in \mathbb{R}^+\\
\end{flalign*}
with constraints
        \begin{flalign*}
            \delta'(\rho,t_K) &\geq \delta\\
            K(t_K,f) &= \operatorname{or}(\set{H(h) \mid~h \mathop{\in} \set{f \mathop{\star} - \mathop{=} t_K}}) \\
            K'(t_K,f) &= \min(M, \set{H'(h) \mid~h \mathop{\in} \set{f \mathop{\star} - \mathop{=} t_K}})
        \end{flalign*}


 
Let $\operatorname{complete}(G)$ be the graph obtained from $G$ by adding an arrow $s \overset{l}{\to} t$, for all nodes $s,t$ and all labels $l$ if $s \overset{l}{\to} t \notin G$.

For every rule $\rho =(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R)\in \mathcal{R}$, 
let $L' \mathop{=} L \mathop{\cup} \operatorname{complete}(\operatorname{Im}(l)) $,
for all morphisms $t_{L'} : L' \mathop{\to} T$,
we define 
\begin{flalign*}
    C(t_{L'}) \mathop{\in} \set{0,1}
\end{flalign*}
with constraints
\begin{flalign*}
    C(t_{L'}) &=\operatorname{and}(\set{x_{t_{L'}(a)} \mid~ a \mathop{\in} \operatorname{E}(\operatorname{dom}(t_{L'}))}) \\
    % C(\rho,t_{L'}) &= \operatorname{and}(\set{x_a \mid~ e \mathop{\in} \operatorname{E}(\operatorname{Im}(t_{L'}))})\\
\end{flalign*}

\subsection{Constraints: all rules decrease}
For all rules $\rho =(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R) \mathop{\in} \mathcal{R}$,
for all morphisms $t_K \mathop{\in} Hom(K,T)$, we add the following constraint 
        % \begin{flalign*}
        %     K'(\rho,t_K,l) &\geq K'(\rho,t_K,r) 
        % \end{flalign*}
        \begin{flalign*}
            K(t_K,l) &= 1 \mathop{\rightarrow} K(t_K,r) \mathop{=} 1\\
            K(t_K,l)&= 1 \mathop{\rightarrow} K'(t_K,l) \mathop{\geq} K'(t_K,r)
        \end{flalign*}
\subsection{Constraints: some rules uniformly decrease}
For all rules $\rho =(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R)$,
for all morphisms $t_K \mathop{\in} Hom(K,T)$,
        \begin{flalign*}
            % and(z_ K(t_K,l)) &= 1 \mathop{\rightarrow} K(t_K,r) \mathop{=} 1\\
            and(z_\rho, K(t_K,l)) &= 1 \mathop{\rightarrow} K'(t_K,l) \mathop{\geq} K'(t_K,r)\mathop{+}\delta'
        \end{flalign*}

For every rule $\rho =(L \overset{l}{\leftarrow} K \overset{r}{\rightarrow} R)$, let $L' \mathop{=} L \mathop{\cup} \operatorname{complete}(\operatorname{Im}(l)) $, 
if we use a fromework $\mathfrak{F}$ with monic matching, 
then we add the following constraint
\begin{flalign*}
    z_\rho \mathop{=} 1 \mathop{\to} \sum_{
    \set{t_{L'}:L' \mathop{\to} T \mid~ 
                    l' \mathop{\star} t_{L'} \text{monic}} 
    } C(t_{L'}) \mathop{\geq} 1\\
\end{flalign*}
otherwise, we add 
\begin{flalign*}
    z_\rho \mathop{=} 1 \mathop{\to} \sum_{
    t_{L'}:L' \mathop{\to} T 
    } C(t_{L'}) \mathop{\geq} 1\\
\end{flalign*}
